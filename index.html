<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bangalore Bus System | BMTC Live Tracking</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Orbitron:wght@400;500;700&family=Montserrat:wght@400;500;600&family=Raleway:wght@400;500;600&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* Dark Theme Variables for Login */
            --login-bg: #0F0F0F;
            --login-card: #1A1A1A;
            --login-primary: #FF6B35;
            --login-primary-dark: #CC552A;
            --login-secondary: #2A2A2A;
            --login-text: #FFFFFF;
            --login-text-light: #AAAAAA;
            --login-border: #333333;
            --login-shadow: rgba(0, 0, 0, 0.5);
            --login-particle: rgba(255, 107, 53, 0.1);
            
            /* Main App Variables */
            --primary: #FF6600;
            --primary-dark: #CC5200;
            --secondary: #333333;
            --secondary-light: #444444;
            --background: #F5F5F5;
            --card-bg: #FFFFFF;
            --text: #222222;
            --text-light: #666666;
            --border: #DDDDDD;
            --shadow: rgba(0, 0, 0, 0.1);
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --info: #17a2b8;
            --particle: rgba(255, 102, 0, 0.05);
        }

        .dark-mode {
            /* Dark Theme Variables */
            --primary: #FF6600;
            --primary-dark: #FF8533;
            --secondary: #1A1A1A;
            --secondary-light: #2A2A2A;
            --background: #121212;
            --card-bg: #1E1E1E;
            --text: #FFFFFF;
            --text-light: #AAAAAA;
            --border: #333333;
            --shadow: rgba(0, 0, 0, 0.3);
            --success: #34C759;
            --warning: #FFD60A;
            --danger: #FF3B30;
            --info: #5AC8FA;
            --particle: rgba(255, 102, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        body {
            background-color: var(--background);
            color: var(--text);
            transition: background-color 0.3s, color 0.3s;
            overflow-x: hidden;
        }

        /* Enhanced Login Screen */
        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--login-bg);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 0.5s, visibility 0.5s;
            overflow: hidden;
        }

        /* Animated Background */
        .animated-bg {
            position: absolute;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: 0;
        }

        .shape {
            position: absolute;
            background: var(--login-particle);
            border-radius: 50%;
            animation: float 15s infinite linear;
        }

        .shape:nth-child(1) {
            width: 80px;
            height: 80px;
            top: 20%;
            left: 10%;
            animation-duration: 20s;
            animation-delay: 0s;
            background: rgba(255, 107, 53, 0.15);
        }

        .shape:nth-child(2) {
            width: 150px;
            height: 150px;
            top: 60%;
            left: 80%;
            animation-duration: 25s;
            animation-delay: 5s;
            background: rgba(255, 107, 53, 0.1);
        }

        .shape:nth-child(3) {
            width: 100px;
            height: 100px;
            top: 10%;
            left: 85%;
            animation-duration: 18s;
            animation-delay: 2s;
            background: rgba(255, 107, 53, 0.12);
        }

        .shape:nth-child(4) {
            width: 120px;
            height: 120px;
            top: 80%;
            left: 15%;
            animation-duration: 22s;
            animation-delay: 8s;
            background: rgba(255, 107, 53, 0.08);
        }

        .shape:nth-child(5) {
            width: 60px;
            height: 60px;
            top: 40%;
            left: 5%;
            animation-duration: 16s;
            animation-delay: 4s;
            background: rgba(255, 107, 53, 0.2);
        }

        .shape:nth-child(6) {
            width: 200px;
            height: 200px;
            top: 70%;
            left: 90%;
            animation-duration: 30s;
            animation-delay: 10s;
            background: rgba(255, 107, 53, 0.05);
        }

        @keyframes float {
            0% {
                transform: translateY(0) rotate(0deg);
                opacity: 0.5;
            }
            25% {
                transform: translateY(-100px) rotate(90deg);
                opacity: 0.8;
            }
            50% {
                transform: translateY(0) rotate(180deg);
                opacity: 0.5;
            }
            75% {
                transform: translateY(100px) rotate(270deg);
                opacity: 0.8;
            }
            100% {
                transform: translateY(0) rotate(360deg);
                opacity: 0.5;
            }
        }

        /* Bus Animation */
        .bus-animation {
            position: absolute;
            top: 50%;
            left: -100px;
            width: 120px;
            height: 60px;
            background: linear-gradient(90deg, var(--login-primary) 0%, #FF8B5A 100%);
            border-radius: 30px 10px 10px 30px;
            animation: busMove 15s linear infinite;
            z-index: 1;
            display: flex;
            align-items: center;
            padding-left: 15px;
            box-shadow: 0 5px 15px rgba(255, 107, 53, 0.3);
        }

        .bus-animation:before {
            content: '';
            position: absolute;
            right: 10px;
            width: 30px;
            height: 30px;
            background: var(--login-bg);
            border-radius: 50%;
        }

        .bus-animation:after {
            content: '';
            position: absolute;
            right: 25px;
            width: 20px;
            height: 20px;
            background: var(--login-bg);
            border-radius: 50%;
        }

        .bus-animation i {
            color: white;
            font-size: 24px;
            animation: busIcon 2s ease-in-out infinite;
        }

        @keyframes busMove {
            0% {
                left: -100px;
                transform: translateY(-50%);
            }
            100% {
                left: 100%;
                transform: translateY(-50%);
            }
        }

        @keyframes busIcon {
            0%, 100% {
                transform: translateX(0);
            }
            50% {
                transform: translateX(5px);
            }
        }

        /* Login Container */
        .login-container {
            background-color: var(--login-card);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 50px var(--login-shadow);
            width: 90%;
            max-width: 450px;
            text-align: center;
            position: relative;
            z-index: 2;
            border: 1px solid var(--login-border);
            transform: translateY(20px);
            opacity: 0;
            animation: fadeUp 0.8s ease-out 0.5s forwards;
        }

        @keyframes fadeUp {
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .login-header {
            margin-bottom: 30px;
        }

        .login-logo {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .logo-icon {
            font-size: 3rem;
            color: var(--login-primary);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.1);
            }
        }

        .login-container h1 {
            font-family: 'Orbitron', sans-serif;
            color: var(--login-primary);
            margin-bottom: 5px;
            font-size: 2.5rem;
            text-shadow: 0 0 10px rgba(255, 107, 53, 0.3);
        }

        .login-container .tagline {
            color: var(--login-text-light);
            font-size: 1rem;
            letter-spacing: 1px;
            margin-bottom: 30px;
            position: relative;
            display: inline-block;
        }

        .login-container .tagline:after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 50px;
            height: 2px;
            background: var(--login-primary);
        }

        .input-group {
            margin-bottom: 25px;
            text-align: left;
            position: relative;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--login-text);
            font-weight: 500;
            font-size: 0.9rem;
        }

        .input-group input {
            width: 100%;
            padding: 15px 20px 15px 50px;
            border: 1px solid var(--login-border);
            border-radius: 10px;
            background-color: var(--login-secondary);
            color: var(--login-text);
            font-size: 1rem;
            transition: all 0.3s;
        }

        .input-group input:focus {
            outline: none;
            border-color: var(--login-primary);
            box-shadow: 0 0 0 2px rgba(255, 107, 53, 0.2);
        }

        .input-icon {
            position: absolute;
            left: 15px;
            top: 40px;
            color: var(--login-text-light);
            transition: color 0.3s;
        }

        .input-group input:focus + .input-icon {
            color: var(--login-primary);
        }

        .login-btn {
            background: linear-gradient(135deg, var(--login-primary) 0%, #FF8B5A 100%);
            color: white;
            border: none;
            padding: 15px 0;
            width: 100%;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
            z-index: 1;
        }

        .login-btn:before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--login-primary-dark) 0%, #FF6B35 100%);
            transition: left 0.5s;
            z-index: -1;
        }

        .login-btn:hover:before {
            left: 0;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(255, 107, 53, 0.3);
        }

        .login-btn:active {
            transform: translateY(0);
        }

        .login-btn i {
            margin-right: 10px;
        }

        .demo-login-btn {
            background: transparent;
            border: 2px solid var(--login-primary);
            color: var(--login-primary);
            margin-top: 15px;
        }

        .demo-login-btn:before {
            background: var(--login-primary);
        }

        .demo-login-btn:hover {
            color: white;
        }

        .login-footer {
            margin-top: 30px;
            color: var(--login-text-light);
            font-size: 0.8rem;
        }

        .login-footer a {
            color: var(--login-primary);
            text-decoration: none;
            transition: color 0.3s;
        }

        .login-footer a:hover {
            color: #FF8B5A;
            text-decoration: underline;
        }

        /* Theme Toggle in Login */
        .login-theme-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 3;
        }

        .theme-toggle-btn {
            background: var(--login-secondary);
            border: 1px solid var(--login-border);
            color: var(--login-text);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: all 0.3s;
        }

        .theme-toggle-btn:hover {
            background: var(--login-primary);
            color: white;
            transform: rotate(30deg);
        }

        /* Main App */
        .app-container {
            display: none;
            width: 100%;
            min-height: 100vh;
        }

        /* Particles Background */
        #particles-js {
            position: fixed;
            width: 100%;
            height: 100%;
            z-index: -1;
            background-color: var(--background);
        }

        /* Header */
        .header {
            background-color: var(--secondary);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px var(--shadow);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo h2 {
            font-family: 'Orbitron', sans-serif;
            color: var(--primary);
            font-size: 1.8rem;
        }

        .logo-icon {
            color: var(--primary);
            font-size: 1.8rem;
        }

        .user-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .theme-toggle {
            background: none;
            border: none;
            color: var(--text);
            font-size: 1.2rem;
            cursor: pointer;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }

        .theme-toggle:hover {
            background-color: var(--secondary-light);
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .logout-btn {
            background: none;
            border: none;
            color: var(--text-light);
            cursor: pointer;
            font-size: 0.9rem;
        }

        .logout-btn:hover {
            color: var(--primary);
        }

        /* Sidebar */
        .sidebar {
            width: 250px;
            background-color: var(--secondary);
            height: calc(100vh - 70px);
            position: fixed;
            left: 0;
            top: 70px;
            overflow-y: auto;
            transition: transform 0.3s;
            z-index: 90;
        }

        .sidebar-nav {
            padding: 20px 0;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 25px;
            color: var(--text);
            text-decoration: none;
            transition: all 0.2s;
            border-left: 4px solid transparent;
            position: relative;
            overflow: hidden;
        }

        .nav-item:before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 102, 0, 0.1), transparent);
            transition: left 0.5s;
        }

        .nav-item:hover:before {
            left: 100%;
        }

        .nav-item:hover, .nav-item.active {
            background-color: var(--secondary-light);
            color: var(--primary);
            border-left-color: var(--primary);
        }

        .nav-item i {
            width: 20px;
            text-align: center;
            font-size: 1.2rem;
        }

        /* Main Content */
        .main-content {
            margin-left: 250px;
            padding: 30px;
            min-height: calc(100vh - 70px);
            transition: margin-left 0.3s;
        }

        /* Dashboard */
        .dashboard-header {
            margin-bottom: 30px;
        }

        .dashboard-header h1 {
            font-family: 'Orbitron', sans-serif;
            font-size: 2.2rem;
            margin-bottom: 10px;
        }

        .dashboard-header p {
            color: var(--text-light);
            font-size: 1rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            background-color: var(--card-bg);
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 5px 15px var(--shadow);
            display: flex;
            align-items: center;
            gap: 20px;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .stat-card:before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 5px;
            height: 100%;
            background: var(--primary);
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px var(--shadow);
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 10px;
            background: linear-gradient(135deg, var(--primary) 0%, #FF8B5A 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
        }

        .stat-info h3 {
            font-size: 1.8rem;
            margin-bottom: 5px;
        }

        .stat-info p {
            color: var(--text-light);
            font-size: 0.9rem;
        }

        .dashboard-section {
            margin-bottom: 40px;
        }

        .section-title {
            font-size: 1.5rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title i {
            color: var(--primary);
        }

        /* Map Container - FIXED */
        .map-container {
            height: 500px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px var(--shadow);
            margin-bottom: 20px;
            position: relative;
            border: 1px solid var(--border);
        }

        .map-container .leaflet-container {
            height: 100%;
            width: 100%;
            border-radius: 10px;
            z-index: 1;
        }

        .map-loading {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--card-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 0;
            border-radius: 10px;
        }

        .map-loading.hidden {
            display: none;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .map-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .control-btn {
            background-color: var(--card-bg);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .control-btn:hover, .control-btn.active {
            background-color: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* Route Finder */
        .search-container {
            background-color: var(--card-bg);
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 5px 15px var(--shadow);
            margin-bottom: 30px;
        }

        .search-box {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 15px;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .search-box {
                grid-template-columns: 1fr;
            }
        }

        .search-input {
            position: relative;
        }

        .search-input input {
            width: 100%;
            padding: 12px 15px 12px 45px;
            border: 1px solid var(--border);
            border-radius: 5px;
            background-color: var(--background);
            color: var(--text);
            font-size: 1rem;
        }

        .search-input i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-light);
        }

        .search-btn {
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 5px;
            padding: 0 25px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .search-btn:hover {
            background-color: var(--primary-dark);
        }

        .filter-options {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .filter-btn {
            background-color: var(--background);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .filter-btn:hover, .filter-btn.active {
            background-color: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* Results */
        .results-container {
            display: none;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .results-count {
            color: var(--text-light);
            font-size: 0.9rem;
        }

        .route-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }

        @media (max-width: 768px) {
            .route-cards {
                grid-template-columns: 1fr;
            }
        }

        .route-card {
            background-color: var(--card-bg);
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px var(--shadow);
            transition: all 0.3s;
        }

        .route-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px var(--shadow);
        }

        .route-card-header {
            background-color: var(--primary);
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .route-number {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.5rem;
            font-weight: 700;
        }

        .route-type {
            background-color: rgba(255, 255, 255, 0.2);
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
        }

        .route-card-body {
            padding: 20px;
        }

        .route-stops {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            font-size: 0.9rem;
        }

        .stop-from, .stop-to {
            font-weight: 600;
        }

        .stop-arrow {
            margin: 0 10px;
            color: var(--primary);
        }

        .route-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .detail-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            color: var(--text-light);
        }

        .detail-item i {
            color: var(--primary);
            width: 16px;
        }

        .route-card-footer {
            padding: 15px 20px;
            background-color: var(--background);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .route-fare {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--primary);
        }

        .track-btn {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .track-btn:hover {
            background-color: var(--primary-dark);
        }

        /* Bus Details Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: var(--card-bg);
            width: 90%;
            max-width: 500px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            transform: scale(0.9);
            opacity: 0;
            animation: modalOpen 0.3s forwards;
        }

        @keyframes modalOpen {
            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .modal-header {
            background-color: var(--primary);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            font-size: 1.5rem;
        }

        .close-modal {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .close-modal:hover {
            transform: scale(1.2);
        }

        .modal-body {
            padding: 20px;
        }

        .bus-detail-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid var(--border);
        }

        .bus-detail-item:last-child {
            border-bottom: none;
        }

        .detail-label {
            color: var(--text-light);
        }

        .detail-value {
            font-weight: 600;
        }

        /* Live Tracking */
        .live-tracking-container {
            display: none;
        }

        .tracking-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .tracking-controls {
            display: flex;
            gap: 10px;
        }

        .refresh-btn {
            background-color: var(--primary);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .refresh-btn:hover {
            background-color: var(--primary-dark);
            transform: rotate(90deg);
        }

        .bus-filter {
            padding: 8px 15px;
            border-radius: 5px;
            border: 1px solid var(--border);
            background-color: var(--background);
            color: var(--text);
            min-width: 200px;
        }

        /* Buses & Timetable */
        .buses-container {
            display: none;
        }

        .buses-table-container {
            background-color: var(--card-bg);
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px var(--shadow);
            margin-bottom: 30px;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid var(--border);
        }

        .table-search {
            position: relative;
        }

        .table-search input {
            padding: 8px 15px 8px 35px;
            border: 1px solid var(--border);
            border-radius: 5px;
            background-color: var(--background);
            color: var(--text);
            width: 250px;
        }

        .table-search i {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-light);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background-color: var(--secondary);
            color: var(--text);
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid var(--border);
            color: var(--text-light);
        }

        tr:hover {
            background-color: var(--background);
        }

        .bus-number-cell {
            font-family: 'Orbitron', sans-serif;
            font-weight: 700;
            color: var(--primary);
        }

        .type-badge {
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .type-ordinary {
            background-color: #e3f2fd;
            color: #1976d2;
        }

        .type-vajra {
            background-color: #e8f5e9;
            color: #388e3c;
        }

        .type-ac {
            background-color: #fff3e0;
            color: #f57c00;
        }

        .type-electric {
            background-color: #f3e5f5;
            color: #7b1fa2;
        }

        /* Alerts */
        .alerts-container {
            display: none;
        }

        .alert-card {
            background-color: var(--card-bg);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 5px 15px var(--shadow);
            border-left: 5px solid var(--warning);
            transition: transform 0.2s;
        }

        .alert-card:hover {
            transform: translateX(5px);
        }

        .alert-card.warning {
            border-left-color: var(--warning);
        }

        .alert-card.danger {
            border-left-color: var(--danger);
        }

        .alert-card.info {
            border-left-color: var(--info);
        }

        .alert-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .alert-title {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .alert-time {
            color: var(--text-light);
            font-size: 0.9rem;
        }

        .alert-body {
            color: var(--text-light);
            line-height: 1.5;
        }

        /* Settings */
        .settings-container {
            display: none;
        }

        .settings-card {
            background-color: var(--card-bg);
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 5px 15px var(--shadow);
            margin-bottom: 30px;
        }

        .settings-group {
            margin-bottom: 25px;
        }

        .settings-group h3 {
            margin-bottom: 15px;
            font-size: 1.2rem;
            color: var(--primary);
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid var(--border);
        }

        .setting-item:last-child {
            border-bottom: none;
        }

        .setting-info h4 {
            margin-bottom: 5px;
        }

        .setting-info p {
            color: var(--text-light);
            font-size: 0.9rem;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--border);
            transition: .4s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: var(--primary);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }

        /* Mobile Menu Button */
        .mobile-menu-btn {
            display: none;
            background: none;
            border: none;
            color: var(--text);
            font-size: 1.5rem;
            cursor: pointer;
        }

        /* Responsive Styles */
        @media (max-width: 1024px) {
            .sidebar {
                transform: translateX(-100%);
            }
            
            .sidebar.active {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .mobile-menu-btn {
                display: block;
            }
        }

        @media (max-width: 768px) {
            .header {
                padding: 15px 20px;
            }
            
            .main-content {
                padding: 20px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }
            
            .search-box {
                grid-template-columns: 1fr;
            }
            
            .table-search input {
                width: 100%;
            }
        }

        /* Animation for page transitions */
        .page-content {
            display: none;
            animation: fadeIn 0.5s;
        }

        .page-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Bus icon colors for different types */
        .bus-icon-ordinary {
            color: #1976d2;
        }

        .bus-icon-vajra {
            color: #388e3c;
        }

        .bus-icon-ac {
            color: #f57c00;
        }

        .bus-icon-electric {
            color: #7b1fa2;
        }

        .bus-icon-mini {
            color: #d32f2f;
        }

        .bus-icon-big10 {
            color: #7b1fa2;
        }
    </style>
</head>
<body>
    <!-- Enhanced Login Screen -->
    <div class="login-screen" id="loginScreen">
        <!-- Animated Background -->
        <div class="animated-bg">
            <div class="shape"></div>
            <div class="shape"></div>
            <div class="shape"></div>
            <div class="shape"></div>
            <div class="shape"></div>
            <div class="shape"></div>
            
            <!-- Animated Bus -->
            <div class="bus-animation">
                <i class="fas fa-bus"></i>
            </div>
        </div>
        
        <!-- Theme Toggle in Login -->
        <div class="login-theme-toggle">
            <button class="theme-toggle-btn" id="loginThemeToggle">
                <i class="fas fa-moon"></i>
            </button>
        </div>
        
        <!-- Login Container -->
        <div class="login-container">
            <div class="login-header">
                <div class="login-logo">
                    <i class="fas fa-bus logo-icon"></i>
                </div>
                <h1>BMTC LIVE</h1>
                <p class="tagline">Real-Time Bangalore Bus Tracking</p>
            </div>
            
            <div class="input-group">
                <label for="username"><i class="fas fa-user"></i> Username</label>
                <input type="text" id="username" placeholder="Enter your username">
                <span class="input-icon"><i class="fas fa-user"></i></span>
            </div>
            
            <div class="input-group">
                <label for="password"><i class="fas fa-lock"></i> Password</label>
                <input type="password" id="password" placeholder="Enter your password">
                <span class="input-icon"><i class="fas fa-lock"></i></span>
            </div>
            
            <button class="login-btn" id="loginBtn">
                <i class="fas fa-sign-in-alt"></i> Login to Dashboard
            </button>
            
            <button class="login-btn demo-login-btn" id="demoLoginBtn">
                <i class="fas fa-rocket"></i> Instant Demo Login
            </button>
            
            <div class="login-footer">
                <p>Track 6,500+ buses across Bangalore • Real-time updates • Route planning</p>
                <p>For demo: Use any credentials or click Instant Demo Login</p>
            </div>
        </div>
    </div>
    
    <!-- Main App Container -->
    <div class="app-container" id="appContainer">
        <!-- Particles Background -->
        <div id="particles-js"></div>
        
        <!-- Header -->
        <header class="header">
            <div class="logo">
                <button class="mobile-menu-btn" id="mobileMenuBtn">
                    <i class="fas fa-bars"></i>
                </button>
                <i class="fas fa-bus logo-icon"></i>
                <h2>BMTC Live</h2>
            </div>
            
            <div class="user-controls">
                <button class="theme-toggle" id="themeToggle">
                    <i class="fas fa-moon"></i>
                </button>
                
                <div class="user-profile">
                    <div class="user-avatar" id="userAvatar">U</div>
                    <div>
                        <div id="userName">Demo User</div>
                        <button class="logout-btn" id="logoutBtn">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </button>
                    </div>
                </div>
            </div>
        </header>
        
        <!-- Sidebar -->
        <nav class="sidebar" id="sidebar">
            <div class="sidebar-nav">
                <a href="#" class="nav-item active" data-page="dashboard">
                    <i class="fas fa-home"></i>
                    <span>Dashboard</span>
                </a>
                <a href="#" class="nav-item" data-page="routeFinder">
                    <i class="fas fa-route"></i>
                    <span>Route Finder</span>
                </a>
                <a href="#" class="nav-item" data-page="liveTracking">
                    <i class="fas fa-satellite-dish"></i>
                    <span>Live Tracking</span>
                </a>
                <a href="#" class="nav-item" data-page="buses">
                    <i class="fas fa-bus"></i>
                    <span>Buses & Timetable</span>
                </a>
                <a href="#" class="nav-item" data-page="alerts">
                    <i class="fas fa-bell"></i>
                    <span>Service Alerts</span>
                </a>
                <a href="#" class="nav-item" data-page="settings">
                    <i class="fas fa-cog"></i>
                    <span>Settings</span>
                </a>
            </div>
        </nav>
        
        <!-- Main Content -->
        <main class="main-content">
            <!-- Dashboard -->
            <div class="page-content active" id="dashboard">
                <div class="dashboard-header">
                    <h1>Welcome to BMTC Live</h1>
                    <p>Real-time tracking of 6,500+ buses across Bangalore</p>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-bus"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="activeBusesCount">1,245</h3>
                            <p>Active Buses Now</p>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-route"></i>
                        </div>
                        <div class="stat-info">
                            <h3>450+</h3>
                            <p>Bus Routes</p>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-info">
                            <h3>2.5M+</h3>
                            <p>Daily Passengers</p>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="stat-info">
                            <h3>18-24H</h3>
                            <p>Service Hours</p>
                        </div>
                    </div>
                </div>
                
                <div class="dashboard-section">
                    <h2 class="section-title">
                        <i class="fas fa-map-marked-alt"></i>
                        <span>Live Bus Map</span>
                    </h2>
                    
                    <div class="map-container">
                        <div class="map-loading" id="dashboardMapLoading">
                            <div class="loading-spinner"></div>
                        </div>
                        <div id="dashboardMap"></div>
                    </div>
                    
                    <div class="map-controls">
                        <button class="control-btn active" id="showAllBuses">
                            <i class="fas fa-bus"></i> All Buses
                        </button>
                        <button class="control-btn" id="showVajraBuses">
                            <i class="fas fa-bus"></i> Vajra Buses
                        </button>
                        <button class="control-btn" id="showACBuses">
                            <i class="fas fa-snowflake"></i> AC Buses
                        </button>
                        <button class="control-btn" id="showElectricBuses">
                            <i class="fas fa-charging-station"></i> Electric Buses
                        </button>
                    </div>
                </div>
                
                <div class="dashboard-section">
                    <h2 class="section-title">
                        <i class="fas fa-bolt"></i>
                        <span>Quick Route Search</span>
                    </h2>
                    
                    <div class="search-container">
                        <div class="search-box">
                            <div class="search-input">
                                <i class="fas fa-map-marker-alt"></i>
                                <input type="text" id="quickFrom" placeholder="From (e.g., Majestic)">
                            </div>
                            
                            <div class="search-input">
                                <i class="fas fa-flag-checkered"></i>
                                <input type="text" id="quickTo" placeholder="To (e.g., Whitefield)">
                            </div>
                            
                            <button class="search-btn" id="quickSearchBtn">
                                <i class="fas fa-search"></i> Find Routes
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Route Finder -->
            <div class="page-content" id="routeFinder">
                <div class="dashboard-header">
                    <h1>Route Finder</h1>
                    <p>Find the best bus routes between any two locations in Bangalore</p>
                </div>
                
                <div class="search-container">
                    <div class="search-box">
                        <div class="search-input">
                            <i class="fas fa-map-marker-alt"></i>
                            <input type="text" id="routeFrom" placeholder="From (e.g., Majestic)">
                        </div>
                        
                        <div class="search-input">
                            <i class="fas fa-flag-checkered"></i>
                            <input type="text" id="routeTo" placeholder="To (e.g., Whitefield)">
                        </div>
                        
                        <button class="search-btn" id="routeSearchBtn">
                            <i class="fas fa-search"></i> Search Routes
                        </button>
                    </div>
                    
                    <div class="filter-options">
                        <button class="filter-btn active" data-filter="all">All Routes</button>
                        <button class="filter-btn" data-filter="fastest">Fastest</button>
                        <button class="filter-btn" data-filter="cheapest">Cheapest</button>
                        <button class="filter-btn" data-filter="scenic">Most Scenic</button>
                        <button class="filter-btn" data-filter="accessible">Wheelchair Accessible</button>
                    </div>
                </div>
                
                <div class="results-container" id="routeResults">
                    <div class="results-header">
                        <h2 class="section-title">
                            <i class="fas fa-route"></i>
                            <span>Route Options</span>
                        </h2>
                        <div class="results-count" id="resultsCount">Showing 0 routes</div>
                    </div>
                    
                    <div class="route-cards" id="routeCards">
                        <!-- Route cards will be dynamically inserted here -->
                    </div>
                </div>
            </div>
            
            <!-- Live Tracking -->
            <div class="page-content" id="liveTracking">
                <div class="dashboard-header">
                    <h1>Live Bus Tracking</h1>
                    <p>Real-time tracking of BMTC buses across Bangalore. Updates every 30 seconds.</p>
                </div>
                
                <div class="tracking-header">
                    <h2 class="section-title">
                        <i class="fas fa-satellite-dish"></i>
                        <span>Live Bus Map</span>
                    </h2>
                    
                    <div class="tracking-controls">
                        <select class="bus-filter" id="busTypeFilter">
                            <option value="all">All Bus Types</option>
                            <option value="ordinary">Ordinary</option>
                            <option value="vajra">Vajra</option>
                            <option value="ac">AC</option>
                            <option value="electric">Electric</option>
                            <option value="mini">Mini</option>
                            <option value="big10">Big 10</option>
                        </select>
                        
                        <button class="refresh-btn" id="refreshTracking">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                </div>
                
                <div class="map-container">
                    <div class="map-loading" id="trackingMapLoading">
                        <div class="loading-spinner"></div>
                    </div>
                    <div id="trackingMap"></div>
                </div>
                
                <div class="dashboard-section">
                    <h2 class="section-title">
                        <i class="fas fa-info-circle"></i>
                        <span>Recently Tracked Buses</span>
                    </h2>
                    
                    <div class="route-cards" id="trackedBuses">
                        <!-- Tracked buses will be dynamically inserted here -->
                    </div>
                </div>
            </div>
            
            <!-- Buses & Timetable -->
            <div class="page-content" id="buses">
                <div class="dashboard-header">
                    <h1>BMTC Buses & Timetable</h1>
                    <p>Complete database of 6,500+ BMTC buses with routes, schedules and fares</p>
                </div>
                
                <div class="buses-table-container">
                    <div class="table-header">
                        <h2 class="section-title">
                            <i class="fas fa-bus"></i>
                            <span>All BMTC Buses</span>
                        </h2>
                        
                        <div class="table-search">
                            <i class="fas fa-search"></i>
                            <input type="text" id="busSearch" placeholder="Search by bus number or route...">
                        </div>
                    </div>
                    
                    <table>
                        <thead>
                            <tr>
                                <th>Bus No.</th>
                                <th>Route</th>
                                <th>Type</th>
                                <th>Frequency</th>
                                <th>First Trip</th>
                                <th>Last Trip</th>
                                <th>Fare Range</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="busesTableBody">
                            <!-- Bus rows will be dynamically inserted here -->
                        </tbody>
                    </table>
                </div>
                
                <div class="dashboard-section">
                    <h2 class="section-title">
                        <i class="fas fa-chart-pie"></i>
                        <span>Bus Type Distribution</span>
                    </h2>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon" style="background: linear-gradient(135deg, #1976d2 0%, #64b5f6 100%);">
                                <i class="fas fa-bus"></i>
                            </div>
                            <div class="stat-info">
                                <h3>3,200</h3>
                                <p>Ordinary Buses</p>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon" style="background: linear-gradient(135deg, #388e3c 0%, #81c784 100%);">
                                <i class="fas fa-bus"></i>
                            </div>
                            <div class="stat-info">
                                <h3>1,850</h3>
                                <p>Vajra Buses</p>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon" style="background: linear-gradient(135deg, #f57c00 0%, #ffb74d 100%);">
                                <i class="fas fa-snowflake"></i>
                            </div>
                            <div class="stat-info">
                                <h3>800</h3>
                                <p>AC Buses</p>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon" style="background: linear-gradient(135deg, #7b1fa2 0%, #ba68c8 100%);">
                                <i class="fas fa-charging-station"></i>
                            </div>
                            <div class="stat-info">
                                <h3>350</h3>
                                <p>Electric Buses</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Alerts -->
            <div class="page-content" id="alerts">
                <div class="dashboard-header">
                    <h1>Service Alerts</h1>
                    <p>Real-time service updates, delays and important announcements</p>
                </div>
                
                <div id="alertsContainer">
                    <!-- Alert cards will be dynamically inserted here -->
                </div>
            </div>
            
            <!-- Settings -->
            <div class="page-content" id="settings">
                <div class="dashboard-header">
                    <h1>Settings</h1>
                    <p>Customize your BMTC Live experience</p>
                </div>
                
                <div class="settings-card">
                    <div class="settings-group">
                        <h3>Preferences</h3>
                        
                        <div class="setting-item">
                            <div class="setting-info">
                                <h4>Dark Mode</h4>
                                <p>Toggle between light and dark theme</p>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="darkModeToggle">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        
                        <div class="setting-item">
                            <div class="setting-info">
                                <h4>Auto-Refresh Map</h4>
                                <p>Automatically refresh bus positions every 30 seconds</p>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="autoRefreshToggle" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        
                        <div class="setting-item">
                            <div class="setting-info">
                                <h4>Show Notifications</h4>
                                <p>Receive alerts for delays and service updates</p>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="notificationsToggle" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="settings-group">
                        <h3>Map Settings</h3>
                        
                        <div class="setting-item">
                            <div class="setting-info">
                                <h4>Default Bus Type Filter</h4>
                                <p>Choose which bus types to show by default on the map</p>
                            </div>
                            <select id="defaultBusFilter">
                                <option value="all">All Buses</option>
                                <option value="vajra">Vajra Only</option>
                                <option value="ac">AC Only</option>
                                <option value="electric">Electric Only</option>
                            </select>
                        </div>
                        
                        <div class="setting-item">
                            <div class="setting-info">
                                <h4>Map Animation Speed</h4>
                                <p>Control how fast buses move on the map</p>
                            </div>
                            <select id="animationSpeed">
                                <option value="slow">Slow</option>
                                <option value="normal" selected>Normal</option>
                                <option value="fast">Fast</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Bus Details Modal -->
    <div class="modal" id="busDetailsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalBusNumber">500A</h3>
                <button class="close-modal" id="closeModal">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Bus details will be dynamically inserted here -->
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Particles.js for background -->
    <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
    
    <script>
        // ==================== 1. USER AUTHENTICATION ====================
        
        // Check if user is already logged in
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize particles background for main app
            particlesJS("particles-js", {
                particles: {
                    number: { value: 80, density: { enable: true, value_area: 800 } },
                    color: { value: "#ff6600" },
                    shape: { type: "circle" },
                    opacity: { value: 0.3, random: true },
                    size: { value: 3, random: true },
                    line_linked: {
                        enable: true,
                        distance: 150,
                        color: "#ff6600",
                        opacity: 0.1,
                        width: 1
                    },
                    move: {
                        enable: true,
                        speed: 2,
                        direction: "none",
                        random: true,
                        straight: false,
                        out_mode: "out",
                        bounce: false
                    }
                },
                interactivity: {
                    detect_on: "canvas",
                    events: {
                        onhover: { enable: true, mode: "repulse" },
                        onclick: { enable: true, mode: "push" }
                    }
                },
                retina_detect: true
            });
            
            // Login theme toggle
            document.getElementById('loginThemeToggle').addEventListener('click', function() {
                const icon = this.querySelector('i');
                if (icon.classList.contains('fa-moon')) {
                    icon.classList.remove('fa-moon');
                    icon.classList.add('fa-sun');
                    // Switch to light theme for login
                    document.querySelector('.login-screen').style.backgroundColor = '#F5F5F5';
                    document.querySelector('.login-container').style.backgroundColor = '#FFFFFF';
                    document.querySelector('.login-container').style.color = '#222222';
                } else {
                    icon.classList.remove('fa-sun');
                    icon.classList.add('fa-moon');
                    // Switch back to dark theme for login
                    document.querySelector('.login-screen').style.backgroundColor = '#0F0F0F';
                    document.querySelector('.login-container').style.backgroundColor = '#1A1A1A';
                    document.querySelector('.login-container').style.color = '#FFFFFF';
                }
            });
            
            // Check for existing session
            const isLoggedIn = localStorage.getItem('bmtcLoggedIn');
            const savedUsername = localStorage.getItem('bmtcUsername');
            
            if (isLoggedIn === 'true' && savedUsername) {
                // User is already logged in
                loginSuccess(savedUsername);
            }
            
            // Login button event
            document.getElementById('loginBtn').addEventListener('click', function() {
                const username = document.getElementById('username').value.trim();
                const password = document.getElementById('password').value.trim();
                
                if (username === '' || password === '') {
                    alert('Please enter both username and password');
                    return;
                }
                
                // For demo purposes, any credentials will work
                loginSuccess(username);
            });
            
            // Demo login button event
            document.getElementById('demoLoginBtn').addEventListener('click', function() {
                // Add click animation
                this.style.transform = 'scale(0.95)';
                setTimeout(() => {
                    this.style.transform = 'scale(1)';
                }, 200);
                
                loginSuccess('Demo User');
            });
            
            // Logout button event
            document.getElementById('logoutBtn').addEventListener('click', function() {
                localStorage.removeItem('bmtcLoggedIn');
                localStorage.removeItem('bmtcUsername');
                
                document.getElementById('loginScreen').style.display = 'flex';
                document.getElementById('appContainer').style.display = 'none';
            });
            
            // Login success function
            function loginSuccess(username) {
                // Save login state
                localStorage.setItem('bmtcLoggedIn', 'true');
                localStorage.setItem('bmtcUsername', username);
                
                // Update UI
                document.getElementById('userName').textContent = username;
                document.getElementById('userAvatar').textContent = username.charAt(0).toUpperCase();
                
                // Animate login screen out
                document.getElementById('loginScreen').style.opacity = '0';
                document.getElementById('loginScreen').style.visibility = 'hidden';
                
                // Show app container
                document.getElementById('appContainer').style.display = 'block';
                document.getElementById('appContainer').style.opacity = '0';
                document.getElementById('appContainer').style.transform = 'translateY(20px)';
                
                // Fade in app
                setTimeout(() => {
                    document.getElementById('appContainer').style.transition = 'opacity 0.5s, transform 0.5s';
                    document.getElementById('appContainer').style.opacity = '1';
                    document.getElementById('appContainer').style.transform = 'translateY(0)';
                }, 100);
                
                // Initialize app components
                setTimeout(() => {
                    initApp();
                }, 600);
            }
            
            // Theme toggle for main app
            document.getElementById('themeToggle').addEventListener('click', function() {
                document.body.classList.toggle('dark-mode');
                const icon = document.querySelector('#themeToggle i');
                
                if (document.body.classList.contains('dark-mode')) {
                    icon.classList.remove('fa-moon');
                    icon.classList.add('fa-sun');
                    localStorage.setItem('bmtcTheme', 'dark');
                } else {
                    icon.classList.remove('fa-sun');
                    icon.classList.add('fa-moon');
                    localStorage.setItem('bmtcTheme', 'light');
                }
            });
            
            // Check for saved theme
            const savedTheme = localStorage.getItem('bmtcTheme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
                document.querySelector('#themeToggle i').classList.remove('fa-moon');
                document.querySelector('#themeToggle i').classList.add('fa-sun');
            }
            
            // Mobile menu toggle
            document.getElementById('mobileMenuBtn').addEventListener('click', function() {
                document.getElementById('sidebar').classList.toggle('active');
            });
            
            // Navigation between pages
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Get the target page
                    const targetPage = this.getAttribute('data-page');
                    
                    // Update active nav item
                    document.querySelectorAll('.nav-item').forEach(nav => {
                        nav.classList.remove('active');
                    });
                    this.classList.add('active');
                    
                    // Show the target page
                    document.querySelectorAll('.page-content').forEach(page => {
                        page.classList.remove('active');
                    });
                    document.getElementById(targetPage).classList.add('active');
                    
                    // Close mobile menu if open
                    document.getElementById('sidebar').classList.remove('active');
                    
                    // Initialize page-specific content
                    if (targetPage === 'dashboard') {
                        initDashboardMap();
                    } else if (targetPage === 'liveTracking') {
                        initTrackingMap();
                    } else if (targetPage === 'buses') {
                        populateBusesTable();
                    } else if (targetPage === 'alerts') {
                        populateAlerts();
                    }
                });
            });
            
            // Close modal
            document.getElementById('closeModal').addEventListener('click', function() {
                document.getElementById('busDetailsModal').style.display = 'none';
            });
            
            // Close modal when clicking outside
            window.addEventListener('click', function(e) {
                if (e.target.id === 'busDetailsModal') {
                    document.getElementById('busDetailsModal').style.display = 'none';
                }
            });
        });
        
        // ==================== 2. DATA INITIALIZATION (6,500+ BUSES) ====================
        
        // Major Bangalore locations for autocomplete
        const bangaloreLocations = [
            "Majestic", "Whitefield", "Koramangala", "Indiranagar", "MG Road", "Jayanagar", 
            "Marathahalli", "Electronic City", "Yeshwanthpur", "Shivajinagar", "KR Puram",
            "BTM Layout", "HSR Layout", "Banashankari", "Malleshwaram", "Rajajinagar",
            "Basavanagudi", "Vijayanagar", "Yelahanka", "Hebbal", "Silk Board", "Tin Factory",
            "Shantinagar", "Domlur", "Ulsoor", "Lalbagh", "Cubbon Park", "City Market",
            "Vidhana Soudha", "Kengeri", "Nagarbhavi", "Bannerghatta Road", "Sarjapur Road",
            "Bellandur", "Kadubeesanahalli", "Mahadevpura", "HAL Airport", "Kempegowda Airport"
        ];
        
        // BMTC Bus Types
        const busTypes = {
            'ordinary': { name: 'Ordinary', color: '#1976d2', icon: 'bus' },
            'vajra': { name: 'Vajra', color: '#388e3c', icon: 'bus' },
            'ac': { name: 'AC', color: '#f57c00', icon: 'snowflake' },
            'electric': { name: 'Electric', color: '#7b1fa2', icon: 'charging-station' },
            'mini': { name: 'Mini', color: '#d32f2f', icon: 'bus' },
            'big10': { name: 'Big 10', color: '#7b1fa2', icon: 'bus' }
        };
        
        // Generate mock BMTC bus data (6,500+ buses)
        const bmtcBuses = [];
        
        // Common route patterns in Bangalore
        const routePatterns = [
            "Majestic - Shivajinagar - Indiranagar - KR Puram - Whitefield",
            "Majestic - Yeshwanthpur - Peenya - Jalahalli - Yelahanka",
            "Majestic - City Market - Jayanagar - Banashankari - Gopalakrishna Temple",
            "Whitefield - KR Puram - Marathahalli - Silk Board - Koramangala",
            "Electronic City - Bommanahalli - HSR Layout - Agara - Koramangala",
            "Koramangala - Madiwala - Silk Board - Marathahalli - KR Puram - Whitefield",
            "Yeshwanthpur - Malleshwaram - Majestic - Shivajinagar - Indiranagar",
            "Banashankari - Jayanagar - South End Circle - Richmond Town - MG Road",
            "Hebbal - Mekhri Circle - Cubbon Park - MG Road - Shivajinagar",
            "Yelahanka - Jalahalli - Yeshwanthpur - Rajajinagar - Majestic",
            "Kengeri - Nagarbhavi - Vijayanagar - Majestic - Shivajinagar",
            "Vidhana Soudha - Cubbon Park - MG Road - Trinity Circle - Indiranagar",
            "Marathahalli - Bellandur - Sarjapur Road - Carmelaram - Electronic City",
            "Silk Board - BTM Layout - Jayanagar - South End Circle - Shantinagar",
            "KR Puram - Mahadevpura - Kadubeesanahalli - Marathahalli - Silk Board"
        ];
        
        // Bus number patterns
        const busNumberPrefixes = ['G', 'K', 'V', 'E', 'B', 'M', 'S', 'R'];
        
        // Generate 6,500+ bus records
        function generateBusData() {
            let busId = 1;
            
            // Generate for each route pattern
            routePatterns.forEach(pattern => {
                // Generate variations of this route
                for (let i = 0; i < 50; i++) {
                    const routeVariation = generateRouteVariation(pattern);
                    const busTypeKeys = Object.keys(busTypes);
                    const busType = busTypeKeys[Math.floor(Math.random() * busTypeKeys.length)];
                    
                    // Generate bus number
                    const prefix = busNumberPrefixes[Math.floor(Math.random() * busNumberPrefixes.length)];
                    const suffix = Math.random() > 0.5 ? String.fromCharCode(65 + Math.floor(Math.random() * 5)) : '';
                    const busNumber = `${prefix}${Math.floor(Math.random() * 500) + 100}${suffix}`;
                    
                    // Generate total buses for this route
                    const totalBuses = Math.floor(Math.random() * 30) + 5;
                    
                    // Generate frequency
                    const frequencyOptions = ["5-8 mins", "8-12 mins", "10-15 mins", "15-20 mins", "20-30 mins"];
                    const frequency = frequencyOptions[Math.floor(Math.random() * frequencyOptions.length)];
                    
                    // Generate fare range
                    const minFare = Math.floor(Math.random() * 10) + 5;
                    const maxFare = minFare + Math.floor(Math.random() * 30) + 10;
                    const fare = `₹${minFare}-₹${maxFare}`;
                    
                    // Create buses for this route
                    for (let j = 0; j < totalBuses; j++) {
                        bmtcBuses.push({
                            id: busId++,
                            busNumber: busNumber,
                            route: routeVariation,
                            type: busType,
                            totalBuses: totalBuses,
                            frequency: frequency,
                            firstTrip: "05:00",
                            lastTrip: "23:00",
                            fare: fare,
                            isActive: Math.random() > 0.2, // 80% active
                            currentLocation: generateRandomLocationInBangalore(),
                            speed: Math.floor(Math.random() * 40) + 20, // 20-60 km/h
                            occupancy: Math.floor(Math.random() * 100), // 0-100%
                            nextStop: `Stop ${Math.floor(Math.random() * 15) + 1}`,
                            delay: Math.random() > 0.7 ? Math.floor(Math.random() * 15) : 0 // 30% delayed
                        });
                    }
                }
            });
            
            console.log(`Generated ${bmtcBuses.length} BMTC bus records`);
        }
        
        // Generate route variation
        function generateRouteVariation(baseRoute) {
            const parts = baseRoute.split(' - ');
            if (Math.random() > 0.5 && parts.length > 3) {
                // Remove a random middle stop
                const removeIndex = Math.floor(Math.random() * (parts.length - 2)) + 1;
                parts.splice(removeIndex, 1);
            }
            
            // Sometimes add an extra stop
            if (Math.random() > 0.7 && parts.length < 8) {
                const extraStops = ["Traffic Police Station", "Bus Depot", "Metro Station", "Shopping Mall", "Hospital"];
                const extraStop = extraStops[Math.floor(Math.random() * extraStops.length)];
                const insertIndex = Math.floor(Math.random() * (parts.length - 1)) + 1;
                parts.splice(insertIndex, 0, extraStop);
            }
            
            return parts.join(' - ');
        }
        
        // Generate random location within Bangalore coordinates
        function generateRandomLocationInBangalore() {
            // Bangalore coordinates bounds
            const latMin = 12.86, latMax = 13.13;
            const lngMin = 77.51, lngMax = 77.78;
            
            return {
                lat: latMin + (Math.random() * (latMax - latMin)),
                lng: lngMin + (Math.random() * (lngMax - lngMin))
            };
        }
        
        // ==================== 3. MAP SETUP ====================
        
        let dashboardMap = null;
        let trackingMap = null;
        let busMarkers = [];
        let activeBuses = [];
        
        // Initialize dashboard map - FIXED VERSION
        function initDashboardMap() {
            if (!dashboardMap) {
                // Hide loading spinner
                document.getElementById('dashboardMapLoading').classList.add('hidden');
                
                // Initialize map
                dashboardMap = L.map('dashboardMap', {
                    zoomControl: true,
                    scrollWheelZoom: true
                }).setView([12.9716, 77.5946], 12);
                
                // Add tile layer
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap contributors',
                    maxZoom: 19
                }).addTo(dashboardMap);
                
                // Add bus markers
                updateDashboardBusMarkers();
                
                // Start updating bus positions
                setInterval(updateDashboardBusMarkers, 30000);
                
                console.log('Dashboard map initialized successfully');
            }
        }
        
        // Initialize tracking map - FIXED VERSION
        function initTrackingMap() {
            if (!trackingMap) {
                // Hide loading spinner
                document.getElementById('trackingMapLoading').classList.add('hidden');
                
                // Initialize map
                trackingMap = L.map('trackingMap', {
                    zoomControl: true,
                    scrollWheelZoom: true
                }).setView([12.9716, 77.5946], 12);
                
                // Add tile layer
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap contributors',
                    maxZoom: 19
                }).addTo(trackingMap);
                
                // Add bus markers
                updateTrackingBusMarkers();
                
                // Start updating bus positions
                setInterval(updateTrackingBusMarkers, 30000);
                
                // Refresh button
                document.getElementById('refreshTracking').addEventListener('click', function() {
                    this.style.transform = 'rotate(360deg)';
                    setTimeout(() => {
                        this.style.transform = 'rotate(0deg)';
                    }, 300);
                    updateTrackingBusMarkers();
                });
                
                // Filter change
                document.getElementById('busTypeFilter').addEventListener('change', function() {
                    updateTrackingBusMarkers();
                });
                
                console.log('Tracking map initialized successfully');
            }
        }
        
        // Update bus markers on dashboard map
        function updateDashboardBusMarkers() {
            // Clear existing markers
            busMarkers.forEach(marker => {
                if (dashboardMap && marker.dashboard) {
                    dashboardMap.removeLayer(marker);
                }
            });
            
            busMarkers = busMarkers.filter(marker => !marker.dashboard);
            
            // Get active buses
            activeBuses = bmtcBuses.filter(bus => bus.isActive);
            document.getElementById('activeBusesCount').textContent = activeBuses.length;
            
            // Add markers for active buses (limit to 50 for performance)
            const displayBuses = activeBuses.slice(0, 50);
            
            displayBuses.forEach(bus => {
                // Create custom icon based on bus type
                const iconColor = busTypes[bus.type].color;
                const busIcon = L.divIcon({
                    html: `<div style="background-color: ${iconColor}; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.5);">B</div>`,
                    className: 'bus-marker',
                    iconSize: [24, 24],
                    iconAnchor: [12, 12]
                });
                
                const marker = L.marker([bus.currentLocation.lat, bus.currentLocation.lng], { icon: busIcon })
                    .addTo(dashboardMap)
                    .bindPopup(`
                        <div style="font-weight: bold; color: ${iconColor}; margin-bottom: 5px;">${bus.busNumber}</div>
                        <div><small>${bus.route.substring(0, 50)}...</small></div>
                        <div><small>Type: ${busTypes[bus.type].name}</small></div>
                        <div><small>Next Stop: ${bus.nextStop}</small></div>
                        <button onclick="showBusDetails(${bus.id})" style="margin-top: 8px; padding: 4px 10px; background-color: ${iconColor}; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 12px;">Details</button>
                    `);
                
                marker.busId = bus.id;
                marker.dashboard = true;
                busMarkers.push(marker);
                
                // Update bus location for next interval
                bus.currentLocation.lat += (Math.random() - 0.5) * 0.01;
                bus.currentLocation.lng += (Math.random() - 0.5) * 0.01;
                
                // Keep within Bangalore bounds
                bus.currentLocation.lat = Math.max(12.86, Math.min(13.13, bus.currentLocation.lat));
                bus.currentLocation.lng = Math.max(77.51, Math.min(77.78, bus.currentLocation.lng));
            });
        }
        
        // Update bus markers on tracking map
        function updateTrackingBusMarkers() {
            // Clear existing markers
            busMarkers.forEach(marker => {
                if (trackingMap && marker.tracking) {
                    trackingMap.removeLayer(marker);
                }
            });
            
            busMarkers = busMarkers.filter(marker => !marker.tracking);
            
            // Get filter value
            const filterValue = document.getElementById('busTypeFilter').value;
            
            // Get active buses with filter
            let filteredBuses = bmtcBuses.filter(bus => bus.isActive);
            
            if (filterValue !== 'all') {
                filteredBuses = filteredBuses.filter(bus => bus.type === filterValue);
            }
            
            // Add markers for filtered buses (limit to 100 for performance)
            const displayBuses = filteredBuses.slice(0, 100);
            
            // Update tracked buses section
            updateTrackedBusesSection(displayBuses.slice(0, 6));
            
            displayBuses.forEach(bus => {
                // Create custom icon based on bus type
                const iconColor = busTypes[bus.type].color;
                const busIcon = L.divIcon({
                    html: `<div style="background-color: ${iconColor}; color: white; border-radius: 50%; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.5); font-size: 12px;">${bus.busNumber.substring(0, 3)}</div>`,
                    className: 'bus-marker',
                    iconSize: [28, 28],
                    iconAnchor: [14, 14]
                });
                
                const marker = L.marker([bus.currentLocation.lat, bus.currentLocation.lng], { icon: busIcon })
                    .addTo(trackingMap)
                    .bindPopup(`
                        <div style="font-weight: bold; font-size: 16px; color: ${iconColor}; margin-bottom: 8px;">${bus.busNumber}</div>
                        <div style="margin-bottom: 5px;"><strong>Route:</strong> ${bus.route.substring(0, 60)}...</div>
                        <div style="margin-bottom: 5px;"><strong>Type:</strong> ${busTypes[bus.type].name}</div>
                        <div style="margin-bottom: 5px;"><strong>Next Stop:</strong> ${bus.nextStop}</div>
                        <div style="margin-bottom: 5px;"><strong>Speed:</strong> ${bus.speed} km/h</div>
                        <div style="margin-bottom: 5px;"><strong>Occupancy:</strong> ${bus.occupancy}%</div>
                        <div style="margin-bottom: 10px;"><strong>Status:</strong> ${bus.delay > 0 ? `<span style="color: #dc3545;">Delayed by ${bus.delay} min</span>` : '<span style="color: #28a745;">On Time</span>'}</div>
                        <button onclick="showBusDetails(${bus.id})" style="padding: 6px 12px; background-color: ${iconColor}; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; width: 100%;">View Full Details</button>
                    `);
                
                marker.busId = bus.id;
                marker.tracking = true;
                busMarkers.push(marker);
                
                // Update bus location for next interval
                bus.currentLocation.lat += (Math.random() - 0.5) * 0.005;
                bus.currentLocation.lng += (Math.random() - 0.5) * 0.005;
                
                // Keep within Bangalore bounds
                bus.currentLocation.lat = Math.max(12.86, Math.min(13.13, bus.currentLocation.lat));
                bus.currentLocation.lng = Math.max(77.51, Math.min(77.78, bus.currentLocation.lng));
                
                // Update some bus properties
                bus.speed = Math.max(5, Math.min(80, bus.speed + (Math.random() - 0.5) * 10));
                bus.occupancy = Math.max(0, Math.min(100, bus.occupancy + (Math.random() - 0.5) * 20));
                
                if (bus.delay > 0) {
                    bus.delay += Math.random() > 0.7 ? 1 : -1;
                    bus.delay = Math.max(0, bus.delay);
                } else if (Math.random() > 0.9) {
                    bus.delay = Math.floor(Math.random() * 10) + 1;
                }
            });
        }
        
        // Update tracked buses section
        function updateTrackedBusesSection(buses) {
            const container = document.getElementById('trackedBuses');
            container.innerHTML = '';
            
            buses.forEach(bus => {
                const busTypeInfo = busTypes[bus.type];
                
                const card = document.createElement('div');
                card.className = 'route-card';
                card.innerHTML = `
                    <div class="route-card-header" style="background-color: ${busTypeInfo.color}">
                        <div class="route-number">${bus.busNumber}</div>
                        <div class="route-type">${busTypeInfo.name}</div>
                    </div>
                    <div class="route-card-body">
                        <div class="route-stops">
                            <div class="stop-from">${bus.route.split(' - ')[0]}</div>
                            <div class="stop-arrow"><i class="fas fa-arrow-right"></i></div>
                            <div class="stop-to">${bus.route.split(' - ').pop()}</div>
                        </div>
                        <div class="route-details">
                            <div class="detail-item">
                                <i class="fas fa-tachometer-alt"></i>
                                <span>${bus.speed} km/h</span>
                            </div>
                            <div class="detail-item">
                                <i class="fas fa-users"></i>
                                <span>${bus.occupancy}% full</span>
                            </div>
                            <div class="detail-item">
                                <i class="fas fa-map-marker-alt"></i>
                                <span>${bus.nextStop}</span>
                            </div>
                            <div class="detail-item">
                                <i class="fas fa-clock"></i>
                                <span>${bus.delay > 0 ? bus.delay + ' min delay' : 'On time'}</span>
                            </div>
                        </div>
                    </div>
                    <div class="route-card-footer">
                        <button class="track-btn" onclick="showBusDetails(${bus.id})">
                            <i class="fas fa-info-circle"></i> Details
                        </button>
                        <button class="track-btn" onclick="focusOnBus(${bus.id})" style="background-color: ${busTypeInfo.color}">
                            <i class="fas fa-map-marker-alt"></i> Track
                        </button>
                    </div>
                `;
                
                container.appendChild(card);
            });
        }
        
        // ==================== 4. ROUTE SEARCH LOGIC ====================
        
        // Initialize route search
        function initRouteSearch() {
            // Quick search
            document.getElementById('quickSearchBtn').addEventListener('click', function() {
                const from = document.getElementById('quickFrom').value.trim();
                const to = document.getElementById('quickTo').value.trim();
                
                if (from && to) {
                    searchRoutes(from, to);
                    // Switch to route finder page
                    document.querySelector('[data-page="routeFinder"]').click();
                } else {
                    alert('Please enter both starting point and destination');
                }
            });
            
            // Main route search
            document.getElementById('routeSearchBtn').addEventListener('click', function() {
                const from = document.getElementById('routeFrom').value.trim();
                const to = document.getElementById('routeTo').value.trim();
                
                if (from && to) {
                    searchRoutes(from, to);
                } else {
                    alert('Please enter both starting point and destination');
                }
            });
            
            // Filter buttons
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Re-filter results if we have a current search
                    const from = document.getElementById('routeFrom').value.trim();
                    const to = document.getElementById('routeTo').value.trim();
                    
                    if (from && to) {
                        searchRoutes(from, to);
                    }
                });
            });
            
            // Set up autocomplete for location inputs
            setupAutocomplete('quickFrom');
            setupAutocomplete('quickTo');
            setupAutocomplete('routeFrom');
            setupAutocomplete('routeTo');
        }
        
        // Setup autocomplete for input fields
        function setupAutocomplete(inputId) {
            const input = document.getElementById(inputId);
            let currentFocus;
            
            input.addEventListener('input', function() {
                const val = this.value;
                closeAllLists();
                
                if (!val) return false;
                
                currentFocus = -1;
                
                // Create autocomplete list
                const list = document.createElement('div');
                list.setAttribute('id', this.id + 'autocomplete-list');
                list.setAttribute('class', 'autocomplete-items');
                this.parentNode.appendChild(list);
                
                // Filter locations
                const matches = bangaloreLocations.filter(loc => 
                    loc.toLowerCase().includes(val.toLowerCase())
                );
                
                // Add matches to list
                matches.forEach(match => {
                    const item = document.createElement('div');
                    item.innerHTML = `<strong>${match.substring(0, val.length)}</strong>${match.substring(val.length)}`;
                    item.innerHTML += `<input type='hidden' value='${match}'>`;
                    
                    item.addEventListener('click', function() {
                        input.value = this.getElementsByTagName('input')[0].value;
                        closeAllLists();
                    });
                    
                    list.appendChild(item);
                });
            });
            
            input.addEventListener('keydown', function(e) {
                let items = document.getElementById(this.id + 'autocomplete-list');
                if (items) items = items.getElementsByTagName('div');
                
                if (e.keyCode == 40) { // Down arrow
                    currentFocus++;
                    addActive(items);
                } else if (e.keyCode == 38) { // Up arrow
                    currentFocus--;
                    addActive(items);
                } else if (e.keyCode == 13) { // Enter
                    e.preventDefault();
                    if (currentFocus > -1 && items) {
                        items[currentFocus].click();
                    }
                }
            });
            
            function addActive(items) {
                if (!items) return false;
                removeActive(items);
                
                if (currentFocus >= items.length) currentFocus = 0;
                if (currentFocus < 0) currentFocus = items.length - 1;
                
                items[currentFocus].classList.add('autocomplete-active');
            }
            
            function removeActive(items) {
                for (let i = 0; i < items.length; i++) {
                    items[i].classList.remove('autocomplete-active');
                }
            }
            
            function closeAllLists(elmnt) {
                const items = document.getElementsByClassName('autocomplete-items');
                for (let i = 0; i < items.length; i++) {
                    if (elmnt != items[i] && elmnt != input) {
                        items[i].parentNode.removeChild(items[i]);
                    }
                }
            }
            
            document.addEventListener('click', function(e) {
                closeAllLists(e.target);
            });
        }
        
        // Search for routes between two locations
        function searchRoutes(from, to) {
            // Show results container
            document.getElementById('routeResults').style.display = 'block';
            
            // Get active filter
            const activeFilter = document.querySelector('.filter-btn.active').getAttribute('data-filter');
            
            // Find routes that contain both from and to locations
            let matchingBuses = bmtcBuses.filter(bus => {
                const route = bus.route.toLowerCase();
                return route.includes(from.toLowerCase()) && route.includes(to.toLowerCase());
            });
            
            // Remove duplicates by bus number
            const uniqueBuses = [];
            const busNumbers = new Set();
            
            matchingBuses.forEach(bus => {
                if (!busNumbers.has(bus.busNumber)) {
                    busNumbers.add(bus.busNumber);
                    uniqueBuses.push(bus);
                }
            });
            
            // Sort based on filter
            if (activeFilter === 'fastest') {
                // Sort by frequency (lower minutes = faster)
                uniqueBuses.sort((a, b) => {
                    const aFreq = parseInt(a.frequency.split('-')[0]);
                    const bFreq = parseInt(b.frequency.split('-')[0]);
                    return aFreq - bFreq;
                });
            } else if (activeFilter === 'cheapest') {
                // Sort by minimum fare
                uniqueBuses.sort((a, b) => {
                    const aFare = parseInt(a.fare.split('₹')[1].split('-')[0]);
                    const bFare = parseInt(b.fare.split('₹')[1].split('-')[0]);
                    return aFare - bFare;
                });
            } else if (activeFilter === 'scenic') {
                // Routes with more stops are considered more scenic
                uniqueBuses.sort((a, b) => {
                    const aStops = a.route.split(' - ').length;
                    const bStops = b.route.split(' - ').length;
                    return bStops - aStops;
                });
            } else if (activeFilter === 'accessible') {
                // Filter for Vajra and AC buses which are more likely to be accessible
                matchingBuses = uniqueBuses.filter(bus => bus.type === 'vajra' || bus.type === 'ac');
            }
            
            // Limit to 10 results
            const results = uniqueBuses.slice(0, 10);
            
            // Update results count
            document.getElementById('resultsCount').textContent = `Showing ${results.length} routes`;
            
            // Display results
            displayRouteResults(results, from, to);
        }
        
        // Display route search results
        function displayRouteResults(routes, from, to) {
            const container = document.getElementById('routeCards');
            container.innerHTML = '';
            
            if (routes.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-light);">
                        <i class="fas fa-route" style="font-size: 48px; margin-bottom: 20px; opacity: 0.5;"></i>
                        <h3>No routes found</h3>
                        <p>Try searching for different locations or check the spelling.</p>
                    </div>
                `;
                return;
            }
            
            routes.forEach(bus => {
                const busTypeInfo = busTypes[bus.type];
                const routeParts = bus.route.split(' - ');
                const fromIndex = routeParts.findIndex(part => part.toLowerCase().includes(from.toLowerCase()));
                const toIndex = routeParts.findIndex(part => part.toLowerCase().includes(to.toLowerCase()));
                
                // Get the segment of the route between from and to
                let routeSegment = bus.route;
                if (fromIndex !== -1 && toIndex !== -1 && fromIndex < toIndex) {
                    routeSegment = routeParts.slice(fromIndex, toIndex + 1).join(' - ');
                }
                
                const card = document.createElement('div');
                card.className = 'route-card';
                card.innerHTML = `
                    <div class="route-card-header" style="background-color: ${busTypeInfo.color}">
                        <div class="route-number">${bus.busNumber}</div>
                        <div class="route-type">${busTypeInfo.name}</div>
                    </div>
                    <div class="route-card-body">
                        <div class="route-stops">
                            <div class="stop-from">${from}</div>
                            <div class="stop-arrow"><i class="fas fa-arrow-right"></i></div>
                            <div class="stop-to">${to}</div>
                        </div>
                        <div style="font-size: 0.85rem; color: var(--text-light); margin-bottom: 15px;">
                            ${routeSegment}
                        </div>
                        <div class="route-details">
                            <div class="detail-item">
                                <i class="fas fa-clock"></i>
                                <span>${bus.frequency}</span>
                            </div>
                            <div class="detail-item">
                                <i class="fas fa-bus"></i>
                                <span>${bus.totalBuses} buses</span>
                            </div>
                            <div class="detail-item">
                                <i class="fas fa-hourglass-start"></i>
                                <span>Starts ${bus.firstTrip}</span>
                            </div>
                            <div class="detail-item">
                                <i class="fas fa-hourglass-end"></i>
                                <span>Ends ${bus.lastTrip}</span>
                            </div>
                        </div>
                    </div>
                    <div class="route-card-footer">
                        <div class="route-fare">${bus.fare}</div>
                        <button class="track-btn" onclick="showBusDetails(${bus.id})">
                            <i class="fas fa-info-circle"></i> Details
                        </button>
                    </div>
                `;
                
                container.appendChild(card);
            });
        }
        
        // ==================== 5. LIVE TRACKING SIMULATION ====================
        
        // Show bus details in modal
        window.showBusDetails = function(busId) {
            const bus = bmtcBuses.find(b => b.id === busId);
            if (!bus) return;
            
            const busTypeInfo = busTypes[bus.type];
            
            document.getElementById('modalBusNumber').textContent = bus.busNumber;
            
            const modalBody = document.getElementById('modalBody');
            modalBody.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <div style="background-color: ${busTypeInfo.color}; color: white; padding: 5px 15px; border-radius: 20px; font-weight: 600;">
                            ${busTypeInfo.name}
                        </div>
                        <div style="color: ${bus.delay > 0 ? '#dc3545' : '#28a745'}; font-weight: 600;">
                            ${bus.delay > 0 ? `Delayed by ${bus.delay} minutes` : 'On Time'}
                        </div>
                    </div>
                    
                    <div style="font-size: 1.1rem; margin-bottom: 15px; color: var(--text);">
                        ${bus.route}
                    </div>
                </div>
                
                <div class="bus-detail-item">
                    <div class="detail-label">Current Location</div>
                    <div class="detail-value">${bus.currentLocation.lat.toFixed(4)}, ${bus.currentLocation.lng.toFixed(4)}</div>
                </div>
                
                <div class="bus-detail-item">
                    <div class="detail-label">Next Stop</div>
                    <div class="detail-value">${bus.nextStop}</div>
                </div>
                
                <div class="bus-detail-item">
                    <div class="detail-label">Speed</div>
                    <div class="detail-value">${bus.speed} km/h</div>
                </div>
                
                <div class="bus-detail-item">
                    <div class="detail-label">Occupancy</div>
                    <div class="detail-value">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="width: 100px; height: 8px; background-color: var(--border); border-radius: 4px; overflow: hidden;">
                                <div style="width: ${bus.occupancy}%; height: 100%; background-color: ${bus.occupancy > 80 ? '#dc3545' : bus.occupancy > 50 ? '#ffc107' : '#28a745'};"></div>
                            </div>
                            <span>${bus.occupancy}%</span>
                        </div>
                    </div>
                </div>
                
                <div class="bus-detail-item">
                    <div class="detail-label">Frequency</div>
                    <div class="detail-value">${bus.frequency}</div>
                </div>
                
                <div class="bus-detail-item">
                    <div class="detail-label">Service Hours</div>
                    <div class="detail-value">${bus.firstTrip} to ${bus.lastTrip}</div>
                </div>
                
                <div class="bus-detail-item">
                    <div class="detail-label">Fare Range</div>
                    <div class="detail-value" style="color: var(--primary); font-size: 1.2rem;">${bus.fare}</div>
                </div>
                
                <div class="bus-detail-item">
                    <div class="detail-label">Active Buses on Route</div>
                    <div class="detail-value">${bus.totalBuses}</div>
                </div>
                
                <div style="margin-top: 25px; display: flex; gap: 10px;">
                    <button onclick="focusOnBus(${bus.id})" style="flex: 1; padding: 12px; background-color: ${busTypeInfo.color}; color: white; border: none; border-radius: 5px; font-weight: 600; cursor: pointer;">
                        <i class="fas fa-map-marker-alt"></i> Track on Map
                    </button>
                    <button onclick="findSimilarRoutes('${bus.busNumber}')" style="flex: 1; padding: 12px; background-color: var(--secondary); color: white; border: none; border-radius: 5px; font-weight: 600; cursor: pointer;">
                        <i class="fas fa-route"></i> Similar Routes
                    </button>
                </div>
            `;
            
            document.getElementById('busDetailsModal').style.display = 'flex';
        };
        
        // Focus on a specific bus on the map
        window.focusOnBus = function(busId) {
            const bus = bmtcBuses.find(b => b.id === busId);
            if (!bus) return;
            
            // Switch to live tracking page
            document.querySelector('[data-page="liveTracking"]').click();
            
            // Wait for map to initialize
            setTimeout(() => {
                if (trackingMap) {
                    trackingMap.setView([bus.currentLocation.lat, bus.currentLocation.lng], 15);
                    
                    // Find and open the marker popup
                    const marker = busMarkers.find(m => m.busId === busId && m.tracking);
                    if (marker) {
                        marker.openPopup();
                    }
                }
            }, 500);
        };
        
        // Find similar routes
        window.findSimilarRoutes = function(busNumber) {
            // Extract the numeric part of the bus number
            const baseNumber = busNumber.replace(/\D/g, '');
            
            // Find buses with similar numbers
            const similarBuses = bmtcBuses.filter(bus => {
                const thisBaseNumber = bus.busNumber.replace(/\D/g, '');
                return Math.abs(parseInt(thisBaseNumber) - parseInt(baseNumber)) < 50;
            }).slice(0, 5);
            
            // Switch to route finder
            document.querySelector('[data-page="routeFinder"]').click();
            
            // Display results
            const container = document.getElementById('routeCards');
            container.innerHTML = '';
            
            // Update search inputs
            document.getElementById('routeFrom').value = '';
            document.getElementById('routeTo').value = '';
            
            // Update results header
            document.getElementById('resultsCount').textContent = `Showing ${similarBuses.length} similar routes`;
            document.getElementById('routeResults').style.display = 'block';
            
            // Display similar buses
            similarBuses.forEach(bus => {
                const busTypeInfo = busTypes[bus.type];
                const routeParts = bus.route.split(' - ');
                
                const card = document.createElement('div');
                card.className = 'route-card';
                card.innerHTML = `
                    <div class="route-card-header" style="background-color: ${busTypeInfo.color}">
                        <div class="route-number">${bus.busNumber}</div>
                        <div class="route-type">${busTypeInfo.name}</div>
                    </div>
                    <div class="route-card-body">
                        <div class="route-stops">
                            <div class="stop-from">${routeParts[0]}</div>
                            <div class="stop-arrow"><i class="fas fa-arrow-right"></i></div>
                            <div class="stop-to">${routeParts[routeParts.length - 1]}</div>
                        </div>
                        <div style="font-size: 0.85rem; color: var(--text-light); margin-bottom: 15px;">
                            ${bus.route.substring(0, 80)}${bus.route.length > 80 ? '...' : ''}
                        </div>
                        <div class="route-details">
                            <div class="detail-item">
                                <i class="fas fa-clock"></i>
                                <span>${bus.frequency}</span>
                            </div>
                            <div class="detail-item">
                                <i class="fas fa-bus"></i>
                                <span>${bus.totalBuses} buses</span>
                            </div>
                            <div class="detail-item">
                                <i class="fas fa-hourglass-start"></i>
                                <span>Starts ${bus.firstTrip}</span>
                            </div>
                            <div class="detail-item">
                                <i class="fas fa-hourglass-end"></i>
                                <span>Ends ${bus.lastTrip}</span>
                            </div>
                        </div>
                    </div>
                    <div class="route-card-footer">
                        <div class="route-fare">${bus.fare}</div>
                        <button class="track-btn" onclick="showBusDetails(${bus.id})">
                            <i class="fas fa-info-circle"></i> Details
                        </button>
                    </div>
                `;
                
                container.appendChild(card);
            });
        };
        
        // ==================== 6. BUSES TABLE ====================
        
        // Populate buses table
        function populateBusesTable() {
            const tableBody = document.getElementById('busesTableBody');
            tableBody.innerHTML = '';
            
            // Display first 50 buses (for performance)
            const displayBuses = bmtcBuses.slice(0, 50);
            
            displayBuses.forEach(bus => {
                const busTypeInfo = busTypes[bus.type];
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td class="bus-number-cell">${bus.busNumber}</td>
                    <td>${bus.route.substring(0, 50)}${bus.route.length > 50 ? '...' : ''}</td>
                    <td>
                        <span class="type-badge type-${bus.type}">
                            ${busTypeInfo.name}
                        </span>
                    </td>
                    <td>${bus.frequency}</td>
                    <td>${bus.firstTrip}</td>
                    <td>${bus.lastTrip}</td>
                    <td>${bus.fare}</td>
                    <td>
                        <button onclick="showBusDetails(${bus.id})" style="padding: 5px 10px; background-color: ${busTypeInfo.color}; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 12px;">
                            <i class="fas fa-info-circle"></i> Details
                        </button>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
            
            // Setup search for buses table
            document.getElementById('busSearch').addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const rows = tableBody.getElementsByTagName('tr');
                
                for (let row of rows) {
                    const cells = row.getElementsByTagName('td');
                    let match = false;
                    
                    for (let cell of cells) {
                        if (cell.textContent.toLowerCase().includes(searchTerm)) {
                            match = true;
                            break;
                        }
                    }
                    
                    row.style.display = match ? '' : 'none';
                }
            });
        }
        
        // ==================== 7. ALERTS ====================
        
        // Populate alerts
        function populateAlerts() {
            const container = document.getElementById('alertsContainer');
            
            const alerts = [
                {
                    id: 1,
                    title: "Heavy Traffic on MG Road",
                    message: "Due to ongoing metro construction, expect delays of 15-20 minutes on all routes passing through MG Road.",
                    type: "warning",
                    time: "2 hours ago",
                    affectedRoutes: ["500A", "335E", "201"]
                },
                {
                    id: 2,
                    title: "Route Diversion in Whitefield",
                    message: "Buses towards ITPL will be diverted via Kundalahalli Gate due to road repair work. Temporary bus stops have been set up.",
                    type: "info",
                    time: "5 hours ago",
                    affectedRoutes: ["500A", "KBS-1", "E-4"]
                },
                {
                    id: 3,
                    title: "New Electric Bus Service Launched",
                    message: "BMTC has launched 50 new electric buses on route 600E (Majestic to Electronic City). These are zero-emission vehicles with improved amenities.",
                    type: "info",
                    time: "1 day ago",
                    affectedRoutes: ["600E", "E-10", "E-12"]
                },
                {
                    id: 4,
                    title: "Service Disruption on Outer Ring Road",
                    message: "Due to a major accident near Marathahalli, all bus services on Outer Ring Road are experiencing significant delays. Alternative routes are suggested.",
                    type: "danger",
                    time: "3 hours ago",
                    affectedRoutes: ["500A", "335E", "K-2"]
                },
                {
                    id: 5,
                    title: "Night Service Extension",
                    message: "Selected Vajra services on major routes will now operate until 1:00 AM to accommodate late-night travelers.",
                    type: "info",
                    time: "2 days ago",
                    affectedRoutes: ["V-1", "V-3", "V-5"]
                }
            ];
            
            container.innerHTML = '';
            
            alerts.forEach(alert => {
                const alertCard = document.createElement('div');
                alertCard.className = `alert-card ${alert.type}`;
                
                alertCard.innerHTML = `
                    <div class="alert-header">
                        <div class="alert-title">${alert.title}</div>
                        <div class="alert-time">${alert.time}</div>
                    </div>
                    <div class="alert-body">
                        <p>${alert.message}</p>
                        <div style="margin-top: 10px; font-size: 0.9rem;">
                            <strong>Affected Routes:</strong> ${alert.affectedRoutes.join(', ')}
                        </div>
                    </div>
                `;
                
                container.appendChild(alertCard);
            });
        }
        
        // ==================== 8. INITIALIZE APP ====================
        
        function initApp() {
            // Generate bus data
            generateBusData();
            
            // Initialize route search
            initRouteSearch();
            
            // Initialize dashboard map
            initDashboardMap();
            
            // Populate initial data
            populateBusesTable();
            populateAlerts();
            
            // Set up map control buttons
            document.getElementById('showAllBuses').addEventListener('click', function() {
                updateDashboardBusMarkers();
                setActiveControl(this);
            });
            
            document.getElementById('showVajraBuses').addEventListener('click', function() {
                // Filter for Vajra buses
                const vajraBuses = bmtcBuses.filter(bus => bus.type === 'vajra' && bus.isActive).slice(0, 30);
                updateDashboardBusMarkersWithFilter(vajraBuses);
                setActiveControl(this);
            });
            
            document.getElementById('showACBuses').addEventListener('click', function() {
                // Filter for AC buses
                const acBuses = bmtcBuses.filter(bus => bus.type === 'ac' && bus.isActive).slice(0, 30);
                updateDashboardBusMarkersWithFilter(acBuses);
                setActiveControl(this);
            });
            
            document.getElementById('showElectricBuses').addEventListener('click', function() {
                // Filter for Electric buses
                const electricBuses = bmtcBuses.filter(bus => bus.type === 'electric' && bus.isActive).slice(0, 30);
                updateDashboardBusMarkersWithFilter(electricBuses);
                setActiveControl(this);
            });
            
            // Update active buses count periodically
            setInterval(() => {
                const activeCount = bmtcBuses.filter(bus => bus.isActive).length;
                document.getElementById('activeBusesCount').textContent = activeCount;
            }, 30000);
            
            console.log('BMTC Live System initialized successfully');
        }
        
        // Helper function to set active control button
        function setActiveControl(activeButton) {
            document.querySelectorAll('.control-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            activeButton.classList.add('active');
        }
        
        // Helper function to update dashboard map with filtered buses
        function updateDashboardBusMarkersWithFilter(filteredBuses) {
            // Clear existing markers
            busMarkers.forEach(marker => {
                if (dashboardMap && marker.dashboard) {
                    dashboardMap.removeLayer(marker);
                }
            });
            
            busMarkers = busMarkers.filter(marker => !marker.dashboard);
            
            // Add markers for filtered buses
            filteredBuses.forEach(bus => {
                const iconColor = busTypes[bus.type].color;
                const busIcon = L.divIcon({
                    html: `<div style="background-color: ${iconColor}; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.5);">B</div>`,
                    className: 'bus-marker',
                    iconSize: [24, 24],
                    iconAnchor: [12, 12]
                });
                
                const marker = L.marker([bus.currentLocation.lat, bus.currentLocation.lng], { icon: busIcon })
                    .addTo(dashboardMap)
                    .bindPopup(`
                        <div style="font-weight: bold; color: ${iconColor}; margin-bottom: 5px;">${bus.busNumber}</div>
                        <div><small>${bus.route.substring(0, 50)}...</small></div>
                        <div><small>Type: ${busTypes[bus.type].name}</small></div>
                        <div><small>Next Stop: ${bus.nextStop}</small></div>
                        <button onclick="showBusDetails(${bus.id})" style="margin-top: 8px; padding: 4px 10px; background-color: ${iconColor}; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 12px;">Details</button>
                    `);
                
                marker.busId = bus.id;
                marker.dashboard = true;
                busMarkers.push(marker);
            });
        }
    </script>
</body>
</html>
